# Lima VM configuration for development icecast testbed
#
# WARNING: FOR DEVELOPMENT AND TESTING ONLY
# DO NOT USE IN PRODUCTION
#
# Creates a Debian 13 VM running icecast with synthetic audio sources.
# See README.md for usage instructions.

minimumLimaVersion: "2.0.0"
vmType: vz

images:
  - location: "https://cloud.debian.org/images/cloud/trixie/20251117-2299/debian-13-genericcloud-amd64-20251117-2299.qcow2"
    arch: "x86_64"
    digest: "sha512:e5563c7bb388eebf7df385e99ee36c83cd16ba8fad4bd07f4c3fd725a6f1cf1cb9f54c6673d4274a856974327a5007a69ff24d44f9b21f7f920e1938a19edf7e"
  - location: "https://cloud.debian.org/images/cloud/trixie/20251117-2299/debian-13-genericcloud-arm64-20251117-2299.qcow2"
    arch: "aarch64"
    digest: "sha512:5075d49a9a85f29d1ee78302785b0d5270fd22c16ca75b4b280f7f4c240fcd34fdfa22ab15a5457aa14fbdbf36d8c5562d1133709b58fc8efdec40e363eba085"

cpus: 2
memory: "2GiB"
disk: "20GiB"

mounts:
  # Mount home directory so provision files are accessible inside the VM
  # Files will be at /Users/<username>/radiostats/radiostats/deploy/dev-testbed/
  - location: "~"
    writable: false

portForwards:
  # Icecast server
  - guestPort: 8000
    hostPort: 8000
    proto: tcp

# No containerd needed - this VM runs native packages
containerd:
  system: false
  user: false

# Provision script runs after VM boots
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux
      # Install icecast and ffmpeg on first boot (non-interactive)
      export DEBIAN_FRONTEND=noninteractive
      apt-get update
      apt-get install -y icecast2 ffmpeg
      echo "Packages installed. Run provision.sh from the dev-testbed directory to complete setup."
